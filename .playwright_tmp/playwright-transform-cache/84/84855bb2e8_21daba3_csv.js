/**
 * Fixed column order for drill-down dataset
 */
export const CSV_COLUMNS = ['projectKey', 'boardId', 'boardName', 'sprintId', 'sprintName', 'sprintState', 'sprintStartDate', 'sprintEndDate', 'issueKey', 'issueSummary', 'issueStatus', 'issueType', 'issueStatusCategory', 'issuePriority', 'issueLabels', 'issueComponents', 'issueFixVersions', 'assigneeDisplayName', 'created', 'updated', 'resolutionDate', 'subtaskCount', 'timeOriginalEstimateHours', 'timeRemainingEstimateHours', 'timeSpentHours', 'timeVarianceHours', 'subtaskTimeOriginalEstimateHours', 'subtaskTimeRemainingEstimateHours', 'subtaskTimeSpentHours', 'subtaskTimeVarianceHours', 'ebmTeam', 'ebmProductArea', 'ebmCustomerSegments', 'ebmValue', 'ebmImpact', 'ebmSatisfaction', 'ebmSentiment', 'ebmSeverity', 'ebmSource', 'ebmWorkCategory', 'ebmGoals', 'ebmTheme', 'ebmRoadmap', 'ebmFocusAreas', 'ebmDeliveryStatus', 'ebmDeliveryProgress', 'storyPoints', 'epicKey', 'epicTitle', 'epicSummary'];

/**
 * Escapes a CSV field value (SSOT: matches client escape rules for contract consistency)
 * Handles comma, quote, newline, tab, carriage return, and control characters.
 * @param {any} value - Value to escape
 * @returns {string} - Escaped CSV field
 */
function escapeCSVField(value) {
  if (value === null || value === undefined) {
    return '';
  }
  const str = String(value);
  const hasSpecial = str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r') || str.includes('\t');
  if (hasSpecial) {
    const escaped = str.replace(/"/g, '""').replace(/\r\n/g, ' ').replace(/\n/g, ' ').replace(/\r/g, ' ');
    return `"${escaped}"`;
  }
  const cleaned = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
  return cleaned;
}

/**
 * Generates CSV string from columns and rows (client-side)
 * @param {string[]} columns - Column names
 * @param {Array<Object>} rows - Array of row objects
 * @returns {string} - CSV string
 */
export function generateCSVClient(columns, rows) {
  const lines = [];

  // Header row
  lines.push(columns.map(escapeCSVField).join(','));

  // Data rows
  for (const row of rows) {
    const values = columns.map(col => escapeCSVField(row[col]));
    lines.push(values.join(','));
  }
  return lines.join('\n');
}

/**
 * Streams CSV to HTTP response (server-side)
 * @param {string[]} columns - Column names
 * @param {Array<Object>} rows - Array of row objects
 * @param {Object} response - Express response object
 */
export function streamCSV(columns, rows, response) {
  response.setHeader('Content-Type', 'text/csv; charset=utf-8');
  response.setHeader('Content-Disposition', 'attachment; filename="jira-report.csv"');

  // Write header
  const header = columns.map(escapeCSVField).join(',') + '\n';
  response.write(header);

  // Stream rows
  for (const row of rows) {
    const values = columns.map(col => escapeCSVField(row[col]));
    const line = values.join(',') + '\n';
    response.write(line);
  }
  response.end();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDU1ZfQ09MVU1OUyIsImVzY2FwZUNTVkZpZWxkIiwidmFsdWUiLCJ1bmRlZmluZWQiLCJzdHIiLCJTdHJpbmciLCJoYXNTcGVjaWFsIiwiaW5jbHVkZXMiLCJlc2NhcGVkIiwicmVwbGFjZSIsImNsZWFuZWQiLCJnZW5lcmF0ZUNTVkNsaWVudCIsImNvbHVtbnMiLCJyb3dzIiwibGluZXMiLCJwdXNoIiwibWFwIiwiam9pbiIsInJvdyIsInZhbHVlcyIsImNvbCIsInN0cmVhbUNTViIsInJlc3BvbnNlIiwic2V0SGVhZGVyIiwiaGVhZGVyIiwid3JpdGUiLCJsaW5lIiwiZW5kIl0sInNvdXJjZXMiOlsiY3N2LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGaXhlZCBjb2x1bW4gb3JkZXIgZm9yIGRyaWxsLWRvd24gZGF0YXNldFxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IENTVl9DT0xVTU5TID0gW1xyXG4gICdwcm9qZWN0S2V5JyxcclxuICAnYm9hcmRJZCcsXHJcbiAgJ2JvYXJkTmFtZScsXHJcbiAgJ3NwcmludElkJyxcclxuICAnc3ByaW50TmFtZScsXHJcbiAgJ3NwcmludFN0YXRlJyxcclxuICAnc3ByaW50U3RhcnREYXRlJyxcclxuICAnc3ByaW50RW5kRGF0ZScsXHJcbiAgJ2lzc3VlS2V5JyxcclxuICAnaXNzdWVTdW1tYXJ5JyxcclxuICAnaXNzdWVTdGF0dXMnLFxyXG4gICdpc3N1ZVR5cGUnLFxyXG4gICdpc3N1ZVN0YXR1c0NhdGVnb3J5JyxcclxuICAnaXNzdWVQcmlvcml0eScsXHJcbiAgJ2lzc3VlTGFiZWxzJyxcclxuICAnaXNzdWVDb21wb25lbnRzJyxcclxuICAnaXNzdWVGaXhWZXJzaW9ucycsXHJcbiAgJ2Fzc2lnbmVlRGlzcGxheU5hbWUnLFxyXG4gICdjcmVhdGVkJyxcclxuICAndXBkYXRlZCcsXHJcbiAgJ3Jlc29sdXRpb25EYXRlJyxcclxuICAnc3VidGFza0NvdW50JyxcclxuICAndGltZU9yaWdpbmFsRXN0aW1hdGVIb3VycycsXHJcbiAgJ3RpbWVSZW1haW5pbmdFc3RpbWF0ZUhvdXJzJyxcclxuICAndGltZVNwZW50SG91cnMnLFxyXG4gICd0aW1lVmFyaWFuY2VIb3VycycsXHJcbiAgJ3N1YnRhc2tUaW1lT3JpZ2luYWxFc3RpbWF0ZUhvdXJzJyxcclxuICAnc3VidGFza1RpbWVSZW1haW5pbmdFc3RpbWF0ZUhvdXJzJyxcclxuICAnc3VidGFza1RpbWVTcGVudEhvdXJzJyxcclxuICAnc3VidGFza1RpbWVWYXJpYW5jZUhvdXJzJyxcclxuICAnZWJtVGVhbScsXHJcbiAgJ2VibVByb2R1Y3RBcmVhJyxcclxuICAnZWJtQ3VzdG9tZXJTZWdtZW50cycsXHJcbiAgJ2VibVZhbHVlJyxcclxuICAnZWJtSW1wYWN0JyxcclxuICAnZWJtU2F0aXNmYWN0aW9uJyxcclxuICAnZWJtU2VudGltZW50JyxcclxuICAnZWJtU2V2ZXJpdHknLFxyXG4gICdlYm1Tb3VyY2UnLFxyXG4gICdlYm1Xb3JrQ2F0ZWdvcnknLFxyXG4gICdlYm1Hb2FscycsXHJcbiAgJ2VibVRoZW1lJyxcclxuICAnZWJtUm9hZG1hcCcsXHJcbiAgJ2VibUZvY3VzQXJlYXMnLFxyXG4gICdlYm1EZWxpdmVyeVN0YXR1cycsXHJcbiAgJ2VibURlbGl2ZXJ5UHJvZ3Jlc3MnLFxyXG4gICdzdG9yeVBvaW50cycsXHJcbiAgJ2VwaWNLZXknLFxyXG4gICdlcGljVGl0bGUnLFxyXG4gICdlcGljU3VtbWFyeScsXHJcbl07XHJcblxyXG4vKipcclxuICogRXNjYXBlcyBhIENTViBmaWVsZCB2YWx1ZSAoU1NPVDogbWF0Y2hlcyBjbGllbnQgZXNjYXBlIHJ1bGVzIGZvciBjb250cmFjdCBjb25zaXN0ZW5jeSlcclxuICogSGFuZGxlcyBjb21tYSwgcXVvdGUsIG5ld2xpbmUsIHRhYiwgY2FycmlhZ2UgcmV0dXJuLCBhbmQgY29udHJvbCBjaGFyYWN0ZXJzLlxyXG4gKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBWYWx1ZSB0byBlc2NhcGVcclxuICogQHJldHVybnMge3N0cmluZ30gLSBFc2NhcGVkIENTViBmaWVsZFxyXG4gKi9cclxuZnVuY3Rpb24gZXNjYXBlQ1NWRmllbGQodmFsdWUpIHtcclxuICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgcmV0dXJuICcnO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3RyID0gU3RyaW5nKHZhbHVlKTtcclxuICBjb25zdCBoYXNTcGVjaWFsID0gc3RyLmluY2x1ZGVzKCcsJykgfHwgc3RyLmluY2x1ZGVzKCdcIicpIHx8IHN0ci5pbmNsdWRlcygnXFxuJykgfHxcclxuICAgIHN0ci5pbmNsdWRlcygnXFxyJykgfHwgc3RyLmluY2x1ZGVzKCdcXHQnKTtcclxuICBpZiAoaGFzU3BlY2lhbCkge1xyXG4gICAgY29uc3QgZXNjYXBlZCA9IHN0ci5yZXBsYWNlKC9cIi9nLCAnXCJcIicpLnJlcGxhY2UoL1xcclxcbi9nLCAnICcpLnJlcGxhY2UoL1xcbi9nLCAnICcpLnJlcGxhY2UoL1xcci9nLCAnICcpO1xyXG4gICAgcmV0dXJuIGBcIiR7ZXNjYXBlZH1cImA7XHJcbiAgfVxyXG4gIGNvbnN0IGNsZWFuZWQgPSBzdHIucmVwbGFjZSgvW1xceDAwLVxceDA4XFx4MEJcXHgwQ1xceDBFLVxceDFGXFx4N0ZdL2csICcnKTtcclxuICByZXR1cm4gY2xlYW5lZDtcclxufVxyXG5cclxuLyoqXHJcbiAqIEdlbmVyYXRlcyBDU1Ygc3RyaW5nIGZyb20gY29sdW1ucyBhbmQgcm93cyAoY2xpZW50LXNpZGUpXHJcbiAqIEBwYXJhbSB7c3RyaW5nW119IGNvbHVtbnMgLSBDb2x1bW4gbmFtZXNcclxuICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSByb3dzIC0gQXJyYXkgb2Ygcm93IG9iamVjdHNcclxuICogQHJldHVybnMge3N0cmluZ30gLSBDU1Ygc3RyaW5nXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVDU1ZDbGllbnQoY29sdW1ucywgcm93cykge1xyXG4gIGNvbnN0IGxpbmVzID0gW107XHJcblxyXG4gIC8vIEhlYWRlciByb3dcclxuICBsaW5lcy5wdXNoKGNvbHVtbnMubWFwKGVzY2FwZUNTVkZpZWxkKS5qb2luKCcsJykpO1xyXG5cclxuICAvLyBEYXRhIHJvd3NcclxuICBmb3IgKGNvbnN0IHJvdyBvZiByb3dzKSB7XHJcbiAgICBjb25zdCB2YWx1ZXMgPSBjb2x1bW5zLm1hcChjb2wgPT4gZXNjYXBlQ1NWRmllbGQocm93W2NvbF0pKTtcclxuICAgIGxpbmVzLnB1c2godmFsdWVzLmpvaW4oJywnKSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbGluZXMuam9pbignXFxuJyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTdHJlYW1zIENTViB0byBIVFRQIHJlc3BvbnNlIChzZXJ2ZXItc2lkZSlcclxuICogQHBhcmFtIHtzdHJpbmdbXX0gY29sdW1ucyAtIENvbHVtbiBuYW1lc1xyXG4gKiBAcGFyYW0ge0FycmF5PE9iamVjdD59IHJvd3MgLSBBcnJheSBvZiByb3cgb2JqZWN0c1xyXG4gKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBFeHByZXNzIHJlc3BvbnNlIG9iamVjdFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHN0cmVhbUNTVihjb2x1bW5zLCByb3dzLCByZXNwb25zZSkge1xyXG4gIHJlc3BvbnNlLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgJ3RleHQvY3N2OyBjaGFyc2V0PXV0Zi04Jyk7XHJcbiAgcmVzcG9uc2Uuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPVwiamlyYS1yZXBvcnQuY3N2XCInKTtcclxuXHJcbiAgLy8gV3JpdGUgaGVhZGVyXHJcbiAgY29uc3QgaGVhZGVyID0gY29sdW1ucy5tYXAoZXNjYXBlQ1NWRmllbGQpLmpvaW4oJywnKSArICdcXG4nO1xyXG4gIHJlc3BvbnNlLndyaXRlKGhlYWRlcik7XHJcblxyXG4gIC8vIFN0cmVhbSByb3dzXHJcbiAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xyXG4gICAgY29uc3QgdmFsdWVzID0gY29sdW1ucy5tYXAoY29sID0+IGVzY2FwZUNTVkZpZWxkKHJvd1tjb2xdKSk7XHJcbiAgICBjb25zdCBsaW5lID0gdmFsdWVzLmpvaW4oJywnKSArICdcXG4nO1xyXG4gICAgcmVzcG9uc2Uud3JpdGUobGluZSk7XHJcbiAgfVxyXG5cclxuICByZXNwb25zZS5lbmQoKTtcclxufVxyXG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBLE9BQU8sTUFBTUEsV0FBVyxHQUFHLENBQ3pCLFlBQVksRUFDWixTQUFTLEVBQ1QsV0FBVyxFQUNYLFVBQVUsRUFDVixZQUFZLEVBQ1osYUFBYSxFQUNiLGlCQUFpQixFQUNqQixlQUFlLEVBQ2YsVUFBVSxFQUNWLGNBQWMsRUFDZCxhQUFhLEVBQ2IsV0FBVyxFQUNYLHFCQUFxQixFQUNyQixlQUFlLEVBQ2YsYUFBYSxFQUNiLGlCQUFpQixFQUNqQixrQkFBa0IsRUFDbEIscUJBQXFCLEVBQ3JCLFNBQVMsRUFDVCxTQUFTLEVBQ1QsZ0JBQWdCLEVBQ2hCLGNBQWMsRUFDZCwyQkFBMkIsRUFDM0IsNEJBQTRCLEVBQzVCLGdCQUFnQixFQUNoQixtQkFBbUIsRUFDbkIsa0NBQWtDLEVBQ2xDLG1DQUFtQyxFQUNuQyx1QkFBdUIsRUFDdkIsMEJBQTBCLEVBQzFCLFNBQVMsRUFDVCxnQkFBZ0IsRUFDaEIscUJBQXFCLEVBQ3JCLFVBQVUsRUFDVixXQUFXLEVBQ1gsaUJBQWlCLEVBQ2pCLGNBQWMsRUFDZCxhQUFhLEVBQ2IsV0FBVyxFQUNYLGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsVUFBVSxFQUNWLFlBQVksRUFDWixlQUFlLEVBQ2YsbUJBQW1CLEVBQ25CLHFCQUFxQixFQUNyQixhQUFhLEVBQ2IsU0FBUyxFQUNULFdBQVcsRUFDWCxhQUFhLENBQ2Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0MsY0FBY0EsQ0FBQ0MsS0FBSyxFQUFFO0VBQzdCLElBQUlB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